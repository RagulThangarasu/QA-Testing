<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Visual Testing ‚Äî Figma vs Stage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/styles.css" />
  <link rel="stylesheet" href="/static/header.css" />
  <link rel="stylesheet" href="/static/loader.css" />
  <link rel="stylesheet" href="/static/issues.css" />
  <link rel="stylesheet" href="/static/toggle.css" />
  <link rel="stylesheet" href="/static/file_upload.css" />
</head>

<body>
  <header>
    <nav>
      <a href="/" id="nav-run" class="active">Visual Testing</a>
      <a href="/broken-links">Broken Links</a>
      <a href="/accessibility">Accessibility</a>
      <a href="/seo-performance">SEO & Performance</a>

      <button id="nav-jira" class="btn-secondary"
        style="font-size: 14px; padding: 6px 12px; cursor: pointer; border: 1px solid #374151; background: #1f2937; color: #fff; margin-left: 20px;">Jira
        Config</button>
      <button id="nav-github" class="btn-secondary"
        style="font-size: 14px; padding: 6px 12px; cursor: pointer; border: 1px solid #374151; background: #24292e; color: #fff; margin-left: 10px;">GitHub
        Config</button>
    </nav>
  </header>
  <main class="container">
    <div id="view-run">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h1 style="margin: 0;">Visual Testing Studio</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
          <button id="btn-push-github" class="btn-primary"
            style="font-size: 14px; padding: 8px 16px; cursor: pointer; background: #238636; border: 1px solid #2ea043; display: flex; align-items: center; gap: 6px;">
            <span>üöÄ</span>
            <span>Push to GitHub</span>
          </button>
          <button id="btn-manage-baselines" class="btn-secondary"
            style="font-size: 14px; padding: 6px 12px; cursor: pointer;">Manage Baselines</button>
          <button id="nav-clear" class="btn-reject" style="font-size: 14px; padding: 6px 12px; cursor: pointer;"
            onclick="window.location.reload()">Clear</button>
          <a href="#" id="nav-history" style="color: var(--accent); text-decoration: none; font-weight: 500;">History
            &rarr;</a>
        </div>

      </div>
      <form id="cmpForm">
        <label>Stage URL
          <input type="url" id="url" name="stage_url" placeholder="https://staging.example.com/page" required />
        </label>

        <div id="figma-upload-section" style="display:none; margin-top: 15px;">
          <label>Figma PNG (Required for new baseline)</label>
          <div class="file-upload-wrapper" id="drop-zone">
            <input type="file" id="figma" name="figma_png" accept="image/png" />
            <div class="file-upload-content">
              <span class="file-upload-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="17 8 12 3 7 8" />
                  <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
              </span>
              <div id="file-text" class="file-upload-text">Click or Drop Figma PNG here</div>
            </div>
          </div>
        </div>


        <label style="margin-top: 10px; display: block;">Component Selector (Optional)
          <span style="font-weight: normal; color: #666; font-size: 0.9em;">(Capture only this element, e.g.
            #header)</span>
          <input type="text" name="component_selector" id="component_selector" placeholder="#hero, .header-main" />
        </label>

        <div class="row">
          <label>Viewport
            <select name="viewport" id="viewport">
              <option value="desktop">Desktop (1366x768)</option>
              <option value="mobile">Mobile (390x844)</option>
              <option value="1280x800">1280x800</option>
              <option value="1440x900" selected>1440x900</option>
              <option value="1920x1080">1920x1080</option>
            </select>
          </label>

          <label>Noise Level (Tolerance)
            <select name="noise_tolerance" id="noise_tolerance">
              <option value="strict">Strict (High Sensitivity)</option>
              <option value="medium" selected>Medium (Standard)</option>
              <option value="relaxed">Relaxed (Low Sensitivity)</option>
            </select>
          </label>



          <label>Pass Threshold (SSIM)
            <input type="number" id="threshold" name="threshold" min="0.5" max="0.99" step="0.01" value="0.85" />
          </label>
        </div>

        <details
          style="margin-bottom: 20px; border: 1px solid #e0e0e0; padding: 12px; border-radius: 8px; background: #fafafa;">
          <summary style="cursor: pointer; font-weight: 600; color: #444;">Advanced Options ‚öôÔ∏è</summary>
          <div style="margin-top: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Ignore Elements (CSS Selectors)
              <span style="font-weight: normal; color: #666; font-size: 0.9em;">(Hide dynamic content like ads,
                popups)</span>
              <textarea name="ignore_selectors" id="ignore_selectors" rows="3"
                placeholder=".ad-banner, #cookie-consent, .timestamp"
                style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 8px; margin-top: 5px; font-family: monospace;"></textarea>
            </label>


            <div style="margin-top: 10px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Wait Time (ms)</label>
              <input type="number" name="wait_time" id="wait_time" value="1000" min="0" step="100"
                style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px;">
              <span style="color: #666; font-size: 0.9em; margin-left: 10px;">(Wait for animations/loading)</span>
            </div>

            <!-- Capture Mode & Height Controls -->
            <div
              style="margin-top: 15px; padding: 14px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0369a1;">üìê Capture Size
                Control</label>
              <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                <div>
                  <label
                    style="display: block; font-size: 0.88em; color: #374151; font-weight: 500; margin-bottom: 4px;">Capture
                    Mode</label>
                  <select name="capture_mode" id="capture_mode" onchange="toggleCaptureMode(this.value)"
                    style="padding: 8px 12px; border: 1px solid #93c5fd; border-radius: 6px; background: #fff; font-size: 0.92em; min-width: 180px;">
                    <option value="fullpage" selected>Full Page (Entire Scroll)</option>
                    <option value="viewport">Viewport Only (Above the Fold)</option>
                    <option value="custom_height">Custom Max Height</option>
                  </select>
                </div>
                <div id="max_height_container" style="display: none;">
                  <label
                    style="display: block; font-size: 0.88em; color: #374151; font-weight: 500; margin-bottom: 4px;">Max
                    Height (px)</label>
                  <input type="number" name="max_capture_height" id="max_capture_height" value="3000" min="500"
                    step="100"
                    style="padding: 8px; border: 1px solid #93c5fd; border-radius: 6px; width: 120px; font-size: 0.92em;">
                </div>
              </div>

              <div style="margin-top: 10px;">
                <label style="display: block; font-size: 0.88em; color: #374151; font-weight: 500; margin-bottom: 4px;">
                  Remove Sections (CSS Selectors)
                  <span style="font-weight: normal; color: #666; font-size: 0.92em;">‚Äî Removes from DOM to shrink page
                    height</span>
                </label>
                <textarea name="remove_selectors" id="remove_selectors" rows="2"
                  placeholder="footer, .newsletter-section, .related-posts, .sidebar"
                  style="width: 100%; border: 1px solid #93c5fd; border-radius: 6px; padding: 8px; font-family: monospace; font-size: 0.88em; background: #fff;"></textarea>
              </div>

              <p style="margin: 8px 0 0 0; font-size: 0.78em; color: #6b7280;">
                üí° <strong>Tip:</strong> Use "Viewport Only" for above-the-fold comparisons. Use "Remove Sections" to
                exclude footers, banners, etc. and reduce the screenshot height.
              </p>
            </div>

            <script>
              function toggleCaptureMode(mode) {
                const maxHeightContainer = document.getElementById('max_height_container');
                if (mode === 'custom_height') {
                  maxHeightContainer.style.display = 'block';
                } else {
                  maxHeightContainer.style.display = 'none';
                }
              }
            </script>

            <div style="margin-top: 15px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500;">Validation Types</label>
              <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                  <input type="checkbox" name="check_layout" checked> Layout & Structure
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                  <input type="checkbox" name="check_content" checked> Text & Content
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                  <input type="checkbox" name="check_colors" checked> Colors & Styles
                </label>
              </div>
            </div>

            <div style="margin-top: 15px;">
              <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-weight: 500;">
                <input type="checkbox" id="enable_pixel_threshold" onchange="togglePixelThreshold(this)">
                Custom Pixel Validation Sensitivity
              </label>
              <div id="pixel_threshold_container"
                style="display: none; margin-top: 10px; padding: 14px; background: #f0f4ff; border: 1px solid #c7d2fe; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <label
                    style="font-weight: 500; font-size: 0.92em; color: #374151; margin: 0; white-space: nowrap;">Sensitivity
                    Threshold</label>
                  <div style="position: relative; display: inline-flex; align-items: center;">
                    <input type="number" name="pixel_threshold" id="pixel_threshold" min="0" max="100" value="75"
                      step="1"
                      style="width: 72px; padding: 7px 28px 7px 10px; border: 1.5px solid #a5b4fc; border-radius: 6px; font-size: 1em; font-family: monospace; font-weight: 600; color: #1e40af; background: #fff; text-align: center; outline: none; transition: border-color 0.2s;"
                      onfocus="this.style.borderColor='#6366f1'"
                      onblur="this.style.borderColor='#a5b4fc'; validatePixelThreshold(this);"
                      oninput="updatePixelIndicator(this.value)">
                    <span
                      style="position: absolute; right: 10px; font-size: 0.9em; color: #6366f1; font-weight: 600; pointer-events: none;">%</span>
                  </div>
                  <span id="pixel_level_badge"
                    style="font-size: 0.78em; padding: 3px 10px; border-radius: 12px; font-weight: 600; background: #dbeafe; color: #1d4ed8; white-space: nowrap;">Strict</span>
                </div>
                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                  <button type="button" onclick="setPixelPreset(25)" class="pixel-preset-btn"
                    style="padding: 4px 12px; font-size: 0.82em; border: 1px solid #cbd5e1; border-radius: 6px; background: #fff; color: #475569; cursor: pointer; transition: all 0.15s;">Loose
                    (25%)</button>
                  <button type="button" onclick="setPixelPreset(50)" class="pixel-preset-btn"
                    style="padding: 4px 12px; font-size: 0.82em; border: 1px solid #cbd5e1; border-radius: 6px; background: #fff; color: #475569; cursor: pointer; transition: all 0.15s;">Medium
                    (50%)</button>
                  <button type="button" onclick="setPixelPreset(75)" class="pixel-preset-btn"
                    style="padding: 4px 12px; font-size: 0.82em; border: 1px solid #cbd5e1; border-radius: 6px; background: #fff; color: #475569; cursor: pointer; transition: all 0.15s;">Strict
                    (75%)</button>
                  <button type="button" onclick="setPixelPreset(95)" class="pixel-preset-btn"
                    style="padding: 4px 12px; font-size: 0.82em; border: 1px solid #cbd5e1; border-radius: 6px; background: #fff; color: #475569; cursor: pointer; transition: all 0.15s;">Pixel-perfect
                    (95%)</button>
                </div>
                <p style="margin: 0; font-size: 0.8em; color: #6b7280;">
                  <strong>0%</strong> = Most tolerant (ignores minor differences) &nbsp;‚Üí&nbsp; <strong>100%</strong> =
                  Most strict (flags every pixel change)
                </p>
              </div>
            </div>

            <script>
              function togglePixelThreshold(checkbox) {
                const container = document.getElementById('pixel_threshold_container');
                if (checkbox.checked) {
                  container.style.display = 'block';
                } else {
                  container.style.display = 'none';
                }
              }

              function validatePixelThreshold(input) {
                let val = parseInt(input.value, 10);
                if (isNaN(val) || val < 0) val = 0;
                if (val > 100) val = 100;
                input.value = val;
                updatePixelIndicator(val);
              }

              function setPixelPreset(val) {
                const input = document.getElementById('pixel_threshold');
                input.value = val;
                updatePixelIndicator(val);
                // Highlight active preset
                document.querySelectorAll('.pixel-preset-btn').forEach(btn => {
                  const match = btn.textContent.match(/\((\d+)%\)/);
                  if (match && parseInt(match[1]) === val) {
                    btn.style.background = '#6366f1';
                    btn.style.color = '#fff';
                    btn.style.borderColor = '#6366f1';
                  } else {
                    btn.style.background = '#fff';
                    btn.style.color = '#475569';
                    btn.style.borderColor = '#cbd5e1';
                  }
                });
              }

              function updatePixelIndicator(val) {
                val = parseInt(val, 10);
                if (isNaN(val)) val = 0;
                const badge = document.getElementById('pixel_level_badge');
                if (val <= 20) {
                  badge.textContent = 'Very Loose';
                  badge.style.background = '#dcfce7'; badge.style.color = '#166534';
                } else if (val <= 40) {
                  badge.textContent = 'Loose';
                  badge.style.background = '#fef9c3'; badge.style.color = '#854d0e';
                } else if (val <= 60) {
                  badge.textContent = 'Medium';
                  badge.style.background = '#fed7aa'; badge.style.color = '#9a3412';
                } else if (val <= 80) {
                  badge.textContent = 'Strict';
                  badge.style.background = '#dbeafe'; badge.style.color = '#1d4ed8';
                } else {
                  badge.textContent = 'Pixel-perfect';
                  badge.style.background = '#fce7f3'; badge.style.color = '#9d174d';
                }
                // Highlight matching preset
                document.querySelectorAll('.pixel-preset-btn').forEach(btn => {
                  const match = btn.textContent.match(/\((\d+)%\)/);
                  if (match && parseInt(match[1]) === val) {
                    btn.style.background = '#6366f1';
                    btn.style.color = '#fff';
                    btn.style.borderColor = '#6366f1';
                  } else {
                    btn.style.background = '#fff';
                    btn.style.color = '#475569';
                    btn.style.borderColor = '#cbd5e1';
                  }
                });
              }

              // Initialize on load
              document.addEventListener('DOMContentLoaded', () => updatePixelIndicator(75));
            </script>


            <div style="margin-top: 15px;">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="highlight_diffs" checked style="margin-right: 8px; transform: scale(1.2);">
                <span style="font-weight: 500;">Highlight Differences</span>
              </label>
              <span style="display: block; color: #666; font-size: 0.9em; margin-left: 24px;">(Draw red boxes and
                overlay on differences)</span>
            </div>
          </div>
        </details>

        <button type="submit">Compare</button>
      </form>

      <div id="loader" class="loader-container hidden">
        <div class="progress-bar-bg">
          <div id="progressFill" class="progress-bar-fill"></div>
        </div>
        <div id="statusText" class="status-text">0% - Starting...</div>
      </div>

      <section id="result" class="hidden">
        <h2>Result</h2>
        <div id="metrics"></div>
        <div id="actions" class="actions hidden">
          <button id="btnApprove" class="btn-approve">Approve & Save</button>
          <button id="btnReject" class="btn-reject">Reject</button>
        </div>
        <div class="downloads">
          <a id="dl_overlay" href="#" download>Download Diff Overlay (PNG)</a>
          <a id="dl_heatmap" href="#" download>Download Diff Heatmap (PNG)</a>
          <a id="dl_aligned" href="#" download>Download Aligned Stage (PNG)</a>
          <a id="dl_report" href="#" download>Download Report (PDF)</a>
        </div>
        <div id="previews" class="grid"></div>
      </section>
    </div>

    <div id="view-history" class="hidden">
      <h1>Test History</h1>

      <div class="filters">
        <button class="filter-btn active" onclick="filterHistory('all', this)">All</button>
        <button class="filter-btn" onclick="filterHistory('pending', this)">Pending Review</button>
        <button class="filter-btn" onclick="filterHistory('start', this)">Approved</button>
        <!-- Using 'start' as lazy way or custom -->
        <button class="filter-btn" onclick="filterHistory('rejected', this)">Rejected</button>
      </div>

      <table>

        <thead>
          <tr>
            <th width="40"><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
            <th>Date</th>
            <th>ID</th>
            <th>Status</th>
            <th>Review</th>
            <th>SSIM</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="history-list"></tbody>
      </table>
      <div id="pagination"
        style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;"></div>
    </div>

    <div id="view-baselines" class="hidden">
      <h1>Baseline Management</h1>
      <div id="baselines-list" class="grid-baselines"></div>
    </div>

    <!-- Baseline History Modal -->
    <div id="baseline-history-modal" class="modal hidden">
      <div class="modal-content" style="max-width: 800px; width: 90%;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3 id="bl-modal-title">History for ...</h3>
          <button onclick="document.getElementById('baseline-history-modal').classList.add('hidden')"
            class="btn-secondary">Close</button>
        </div>
        <table style="width:100%; margin-top:15px;">
          <thead>
            <tr>
              <th>Version</th>
              <th>Date</th>
              <th>Job ID</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="bl-history-list"></tbody>
        </table>
      </div>
    </div>


    <div id="toast" class="toast hidden"></div>

    <!-- Modals -->
    <div id="jira-config-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Jira Configuration</h3>
        <label>Server URL <input type="text" id="jira-server" placeholder="https://your-domain.atlassian.net"></label>
        <label>Email <input type="email" id="jira-email" placeholder="email@example.com"></label>
        <label>API Token <input type="password" id="jira-token" placeholder="API Token"></label>
        <label>Project Key <input type="text" id="jira-project" placeholder="PROJ"></label>
        <div class="modal-actions">
          <button id="btnSaveJira">Save & Test</button>
          <button onclick="document.getElementById('jira-config-modal').classList.add('hidden')"
            class="btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <div id="jira-report-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Report to Jira</h3>
        <label>Summary <input type="text" id="jira-summary"></label>
        <label>Description <textarea id="jira-desc" rows="5"></textarea></label>
        <div class="modal-actions">
          <button id="btnSendJira">Create Issue</button>
          <button onclick="document.getElementById('jira-report-modal').classList.add('hidden')"
            class="btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- GitHub Modals -->
    <div id="github-config-modal" class="modal hidden">
      <div class="modal-content">
        <h3>GitHub Configuration</h3>
        <label>Personal Access Token <input type="password" id="gh-token" placeholder="ghp_..."></label>
        <label>Repo Owner <input type="text" id="gh-owner" placeholder="octocat"></label>
        <label>Repo Name <input type="text" id="gh-repo" placeholder="hello-world"></label>
        <div class="modal-actions">
          <button id="btnSaveGitHub">Save & Test</button>
          <button onclick="document.getElementById('github-config-modal').classList.add('hidden')"
            class="btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <div id="github-report-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Report to GitHub</h3>
        <label>Title <input type="text" id="gh-title" placeholder="Visual regression detected..."></label>
        <label>Body <textarea id="gh-body" rows="5" placeholder="Description of the issue..."></textarea></label>
        <div class="modal-actions">
          <button id="btnSendGitHub">Create Issue</button>
          <button onclick="document.getElementById('github-report-modal').classList.add('hidden')"
            class="btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Git Push Modal -->
    <div id="git-push-modal" class="modal hidden">
      <div class="modal-content">
        <h3>üöÄ Push to GitHub</h3>
        <div id="git-status-info"
          style="margin-bottom: 15px; padding: 12px; background: #1e293b; border-radius: 6px; font-size: 13px; color: #e2e8f0; border: 1px solid #334155;">
          <div style="margin-bottom: 6px;"><strong style="color: #94a3b8;">Branch:</strong> <span
              id="git-current-branch" style="color: #10b981; font-weight: 600;">...</span></div>
          <div style="margin-bottom: 6px;"><strong style="color: #94a3b8;">Changes:</strong> <span
              id="git-changes-count" style="color: #f59e0b; font-weight: 600;">...</span></div>
          <div><strong style="color: #94a3b8;">Last Commit:</strong> <span id="git-last-commit"
              style="color: #e2e8f0;">...</span></div>
        </div>
        <label>Commit Message
          <input type="text" id="git-commit-message" placeholder="üé® Update from Visual Testing Tool"
            value="üé® Update baselines and tests">
        </label>
        <label>Branch
          <input type="text" id="git-branch" placeholder="main" value="main">
        </label>
        <div
          style="margin: 15px 0; padding: 10px; background: #eff6ff; border-left: 3px solid #3b82f6; border-radius: 4px;">
          <p style="margin: 0; font-size: 13px; color: #1e40af;">
            ‚ÑπÔ∏è This will automatically:
          </p>
          <ul style="margin: 8px 0 0 20px; font-size: 13px; color: #1e40af;">
            <li>Stage all changes (git add .)</li>
            <li>Commit with your message</li>
            <li>Push to GitHub</li>
            <li>Trigger automated visual tests</li>
          </ul>
        </div>
        <div id="git-push-progress" class="hidden" style="margin: 15px 0;">
          <div class="progress-bar-bg">
            <div id="git-push-progress-fill" class="progress-bar-fill" style="width: 0%"></div>
          </div>
          <div id="git-push-status" style="margin-top: 8px; font-size: 13px; color: #666;"></div>
        </div>
        <div class="modal-actions">
          <button id="btnExecutePush">Push Changes</button>
          <button onclick="document.getElementById('git-push-modal').classList.add('hidden')"
            class="btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </main>

  <script src="/static/app.js?v=5"></script>
  <script src="/static/jira_integration.js"></script>
  <script src="/static/github_integration.js"></script>
  <script src="/static/git_push.js"></script>
</body>

</html>