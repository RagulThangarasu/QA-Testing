name: Automated Visual Regression Tests

on:
  push:
    branches: [ "main", "staging", "develop" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"

jobs:
  visual-regression-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps

    - name: Download baselines from artifacts (if available)
      continue-on-error: true
      uses: actions/download-artifact@v3
      with:
        name: visual-baselines
        path: baselines/

    - name: Run automated visual tests
      id: visual_tests
      run: |
        python run_automated_tests.py --config auto_test_config.json --output ci_test_results
      continue-on-error: true

    - name: Process test results
      id: process_results
      if: always()
      run: |
        # Find the latest results file
        RESULTS_FILE=$(ls -t ci_test_results/results_*.json | head -1)
        
        if [ -f "$RESULTS_FILE" ]; then
          echo "results_file=$RESULTS_FILE" >> $GITHUB_OUTPUT
          
          # Extract key metrics
          TOTAL=$(jq -r '.total_tests' "$RESULTS_FILE")
          PASSED=$(jq -r '.passed' "$RESULTS_FILE")
          FAILED=$(jq -r '.failed' "$RESULTS_FILE")
          THRESHOLD_EXCEEDED=$(jq -r '.threshold_exceeded' "$RESULTS_FILE")
          BUILD_FAIL=$(jq -r '.build_should_fail' "$RESULTS_FILE")
          
          echo "total_tests=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "threshold_exceeded=$THRESHOLD_EXCEEDED" >> $GITHUB_OUTPUT
          echo "build_should_fail=$BUILD_FAIL" >> $GITHUB_OUTPUT
          
          # Create summary
          echo "## üé® Visual Regression Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ö†Ô∏è Threshold Exceeded | $THRESHOLD_EXCEEDED |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$BUILD_FAIL" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚ùå Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "Visual differences exceed the configured threshold." >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: visual-test-results-${{ github.run_number }}
        path: ci_test_results/
        retention-days: 30

    - name: Comment on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const resultsFile = '${{ steps.process_results.outputs.results_file }}';
          
          if (!fs.existsSync(resultsFile)) {
            console.log('No results file found');
            return;
          }
          
          const results = JSON.parse(fs.readFileSync(resultsFile, 'utf8'));
          
          let comment = '## üé® Visual Regression Test Results\n\n';
          comment += `| Metric | Value |\n`;
          comment += `|--------|-------|\n`;
          comment += `| Total Tests | ${results.total_tests} |\n`;
          comment += `| ‚úÖ Passed | ${results.passed} |\n`;
          comment += `| ‚ùå Failed | ${results.failed} |\n`;
          comment += `| ‚ö†Ô∏è Threshold Exceeded | ${results.threshold_exceeded} |\n\n`;
          
          if (results.build_should_fail) {
            comment += '### ‚ùå Build Failed\n\n';
            comment += 'Visual differences exceed the configured threshold.\n\n';
          }
          
          comment += '### Test Details\n\n';
          results.tests.forEach(test => {
            const icon = test.status === 'passed' ? '‚úÖ' : '‚ùå';
            comment += `${icon} **${test.name}**\n`;
            if (test.diff_percentage !== undefined) {
              comment += `   - Difference: ${test.diff_percentage.toFixed(2)}%\n`;
              comment += `   - Threshold: ${test.threshold}%\n`;
            }
            if (test.reason) {
              comment += `   - ${test.reason}\n`;
            }
            comment += '\n';
          });
          
          comment += `\nüìä [View detailed artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Create commit status
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const buildFail = '${{ steps.process_results.outputs.build_should_fail }}' === 'true';
          const state = buildFail ? 'failure' : 'success';
          const description = buildFail 
            ? 'Visual differences exceed threshold' 
            : 'All visual tests passed';
          
          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.sha,
            state: state,
            target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            description: description,
            context: 'Visual Regression Tests'
          });

    - name: Fail build if threshold exceeded
      if: steps.process_results.outputs.build_should_fail == 'true'
      run: |
        echo "‚ùå Build failed due to visual regression threshold exceeded"
        exit 1
