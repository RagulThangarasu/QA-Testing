name: ğŸ¨ Visual Regression CI

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Triggers:
#   â€¢ PR opened / updated / reopened â†’ run full visual regression
#   â€¢ Push to main/staging           â†’ update baselines (optional, guarded)
#   â€¢ Manual dispatch                â†’ run on any branch with inputs
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  pull_request:
    branches: [main, staging, develop]
    types: [opened, synchronize, reopened, ready_for_review]

  push:
    branches: [main, staging]

  workflow_dispatch:
    inputs:
      staging_url:
        description: "Staging URL to test against (overrides auto-detect)"
        required: false
        default: ""
      pr_number:
        description: "PR number to comment on (optional)"
        required: false
        default: ""
      noise_tolerance:
        description: "Sensitivity: strict | medium | relaxed"
        required: false
        default: "medium"
      update_baselines:
        description: "Update baselines after passing tests? (true/false)"
        required: false
        default: "false"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Cancel any in-progress run for the same branch (saves CI minutes)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: visual-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  OUTPUT_DIR: ci_visual_results
  BASELINE_DIR: design_baselines
  PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  JOB 1 â€” SETUP: Detect staging URL from PR context
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect-environment:
    name: ğŸ” Detect Staging URL
    runs-on: ubuntu-latest
    outputs:
      staging_url: ${{ steps.detect.outputs.staging_url }}
      pr_number:   ${{ steps.detect.outputs.pr_number }}
      sha:         ${{ steps.detect.outputs.sha }}
      skip:        ${{ steps.detect.outputs.skip }}

    steps:
      - name: Detect staging URL and context
        id: detect
        run: |
          # â”€â”€ PR Event â”€â”€
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            SHA="${{ github.event.pull_request.head.sha }}"
            # Strategy: use PR label "staging-url:https://..." or fallback to secret
            LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
            STAGING=$(echo "$LABELS" | grep -oP '(?<=staging-url:)[^\s"]+' | head -1 || true)
            if [ -z "$STAGING" ]; then
              # Try env var with PR number interpolated
              STAGING="${{ secrets.STAGING_BASE_URL }}/pr-${PR_NUMBER}"
            fi
            if [ -z "$STAGING" ]; then
              STAGING="${{ secrets.STAGING_URL }}"
            fi
            echo "staging_url=$STAGING" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER"  >> $GITHUB_OUTPUT
            echo "sha=$SHA"             >> $GITHUB_OUTPUT
            echo "skip=false"           >> $GITHUB_OUTPUT

          # â”€â”€ Push Event â”€â”€
          elif [ "${{ github.event_name }}" = "push" ]; then
            STAGING="${{ secrets.STAGING_URL }}"
            echo "staging_url=$STAGING" >> $GITHUB_OUTPUT
            echo "pr_number="           >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            if [ -z "$STAGING" ]; then
              echo "skip=true"          >> $GITHUB_OUTPUT
            else
              echo "skip=false"         >> $GITHUB_OUTPUT
            fi

          # â”€â”€ Manual Dispatch â”€â”€
          else
            STAGING="${{ github.event.inputs.staging_url }}"
            if [ -z "$STAGING" ]; then
              STAGING="${{ secrets.STAGING_URL }}"
            fi
            echo "staging_url=$STAGING" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}"  >> $GITHUB_OUTPUT
            if [ -z "$STAGING" ]; then
              echo "skip=true"          >> $GITHUB_OUTPUT
            else
              echo "skip=false"         >> $GITHUB_OUTPUT
            fi
          fi

      - name: Echo detected values
        run: |
          echo "ğŸŒ Staging URL : ${{ steps.detect.outputs.staging_url }}"
          echo "ğŸ”¢ PR Number   : ${{ steps.detect.outputs.pr_number }}"
          echo "ğŸ”‘ SHA         : ${{ steps.detect.outputs.sha }}"
          echo "â­  Skip        : ${{ steps.detect.outputs.skip }}"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  JOB 2 â€” VISUAL REGRESSION TESTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  visual-regression:
    name: ğŸ¨ Visual Regression Tests
    runs-on: ubuntu-latest
    needs: detect-environment
    if: needs.detect-environment.outputs.skip != 'true'

    permissions:
      contents: read
      pull-requests: write   # to post PR comments
      statuses: write        # to post commit status checks
      checks: write          # to create check runs

    steps:
      # â”€â”€ Checkout â”€â”€
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€ Python â”€â”€
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      # â”€â”€ Install Python deps â”€â”€
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # â”€â”€ Playwright â”€â”€
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: playwright-${{ runner.os }}-${{ hashFiles('requirements.txt') }}

      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium --with-deps

      # â”€â”€ Restore Baselines â”€â”€
      - name: Restore approved baselines
        uses: actions/cache@v4
        with:
          path: ${{ env.BASELINE_DIR }}
          key: visual-baselines-${{ hashFiles('design_baselines/**/*.png', 'design_baselines/baseline_index.json') }}
          restore-keys: |
            visual-baselines-

      # â”€â”€ Also try downloading from artifacts â”€â”€
      - name: Download baseline artifacts (if available)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: approved-baselines
          path: ${{ env.BASELINE_DIR }}

      - name: List available baselines
        run: |
          echo "ğŸ“ Baselines:"
          ls -la ${{ env.BASELINE_DIR }} 2>/dev/null || echo "(none found â€” tests will be skipped)"

      # â”€â”€ Post pending status â”€â”€
      - name: Post pending commit status
        if: needs.detect-environment.outputs.sha != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ needs.detect-environment.outputs.sha }}',
              state: 'pending',
              description: 'ğŸ”¬ Visual regression tests are running...',
              context: 'visual-regression/qa-framework',
            });
            console.log('Posted pending status');

      # â”€â”€ Wait for staging to be ready â”€â”€
      - name: Wait for staging URL to be accessible
        env:
          STAGING_URL: ${{ needs.detect-environment.outputs.staging_url }}
        run: |
          echo "â³ Waiting for staging to be ready: $STAGING_URL"
          MAX_WAIT=120
          ELAPSED=0
          until curl -sf --max-time 10 "$STAGING_URL" > /dev/null 2>&1; do
            if [ $ELAPSED -ge $MAX_WAIT ]; then
              echo "âš ï¸  Staging not ready after ${MAX_WAIT}s â€” proceeding anyway"
              break
            fi
            echo "  Waiting... (${ELAPSED}s)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          echo "âœ… Staging accessible (or timeout reached)"

      # â”€â”€ Run Visual Tests â”€â”€
      - name: Run visual regression tests
        id: run_tests
        env:
          STAGING_URL:   ${{ needs.detect-environment.outputs.staging_url }}
          PR_NUMBER:     ${{ needs.detect-environment.outputs.pr_number }}
          SHA:           ${{ needs.detect-environment.outputs.sha }}
          GITHUB_TOKEN:  ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER:  ${{ github.repository_owner }}
          GITHUB_REPO:   ${{ github.event.repository.name }}
          SERVER_URL:    ${{ secrets.QA_SERVER_URL }}
        run: |
          # Write github config for the client
          cat > github_config.json <<EOF
          {
            "token": "$GITHUB_TOKEN",
            "owner": "$GITHUB_OWNER",
            "repo": "$GITHUB_REPO"
          }
          EOF

          NOISE="${{ github.event.inputs.noise_tolerance || 'medium' }}"

          python run_visual_ci.py \
            --staging-url "$STAGING_URL" \
            --pr-number "${PR_NUMBER:-}" \
            --sha "$SHA" \
            --output "${{ env.OUTPUT_DIR }}" \
            --config ci_visual_config.json \
            --baseline-dir "${{ env.BASELINE_DIR }}" \
            --server-url "${SERVER_URL:-}" \
            --noise-tolerance "$NOISE"
        continue-on-error: true

      # â”€â”€ Extract results â”€â”€
      - name: Parse test results
        id: parse
        run: |
          # Find most recent results file
          RESULTS_FILE=$(ls -t ${{ env.OUTPUT_DIR }}/results_*.json 2>/dev/null | head -1)
          if [ -f "$RESULTS_FILE" ]; then
            echo "results_file=$RESULTS_FILE" >> $GITHUB_OUTPUT
            TOTAL=$(jq  -r '.total_tests'      "$RESULTS_FILE")
            PASSED=$(jq -r '.passed'            "$RESULTS_FILE")
            FAILED=$(jq -r '.failed'            "$RESULTS_FILE")
            SHOULD_FAIL=$(jq -r '.build_should_fail' "$RESULTS_FILE")
            echo "total=$TOTAL"               >> $GITHUB_OUTPUT
            echo "passed=$PASSED"             >> $GITHUB_OUTPUT
            echo "failed=$FAILED"             >> $GITHUB_OUTPUT
            echo "build_should_fail=$SHOULD_FAIL" >> $GITHUB_OUTPUT
          else
            echo "No results file found"
            echo "total=0"                    >> $GITHUB_OUTPUT
            echo "passed=0"                   >> $GITHUB_OUTPUT
            echo "failed=0"                   >> $GITHUB_OUTPUT
            echo "build_should_fail=false"    >> $GITHUB_OUTPUT
          fi

      # â”€â”€ GitHub Step Summary â”€â”€
      - name: Write job summary
        if: always()
        run: |
          echo "## ğŸ¨ Visual Regression Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:-------|:------|" >> $GITHUB_STEP_SUMMARY
          echo "| Staging URL | \`${{ needs.detect-environment.outputs.staging_url }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | \`${{ steps.parse.outputs.total }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | \`${{ steps.parse.outputs.passed }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | \`${{ steps.parse.outputs.failed }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.parse.outputs.build_should_fail }}" = "true" ]; then
            echo "### âŒ Build would fail â€” visual regressions exceed threshold" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All visual checks passed!" >> $GITHUB_STEP_SUMMARY
          fi

      # â”€â”€ Update commit status â”€â”€
      - name: Post final commit status
        if: always() && needs.detect-environment.outputs.sha != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: actions/github-script@v7
        with:
          script: |
            const shouldFail = '${{ steps.parse.outputs.build_should_fail }}' === 'true';
            const state       = shouldFail ? 'failure' : 'success';
            const total       = '${{ steps.parse.outputs.total }}';
            const passed      = '${{ steps.parse.outputs.passed }}';
            const failed      = '${{ steps.parse.outputs.failed }}';
            const description = shouldFail
              ? `âŒ ${failed}/${total} visual check(s) failed`
              : `âœ… All ${total} visual check(s) passed`;

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ needs.detect-environment.outputs.sha }}',
              state,
              description,
              context: 'visual-regression/qa-framework',
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            });
            console.log(`Posted ${state} status: ${description}`);

      # â”€â”€ Upload test artifacts â”€â”€
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-test-results-${{ github.run_number }}
          path: ${{ env.OUTPUT_DIR }}/
          retention-days: 30

      # â”€â”€ Update baselines (only on main push with passing tests) â”€â”€
      - name: Upload approved baselines artifact
        if: |
          github.event_name == 'push' &&
          github.ref == 'refs/heads/main' &&
          steps.parse.outputs.build_should_fail != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: approved-baselines
          path: ${{ env.BASELINE_DIR }}/
          retention-days: 90
          overwrite: true

      # â”€â”€ Fail the build if needed â”€â”€
      - name: Fail build on regression
        if: steps.parse.outputs.build_should_fail == 'true'
        run: |
          echo "âŒ BUILD FAILED â€” ${{ steps.parse.outputs.failed }} visual regression(s) detected"
          exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  JOB 3 â€” BASELINE EXPORT (runs after merge to main)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  export-baselines:
    name: ğŸ“¦ Export Baselines
    runs-on: ubuntu-latest
    needs: visual-regression
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.visual-regression.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: visual-test-results-${{ github.run_number }}
          path: ci_visual_results/

      - name: Extract passing screenshots as new baselines
        run: |
          echo "ğŸ“¤ Promoting passing screenshots to design_baselines/"
          mkdir -p design_baselines

          # For each passing test, copy the current stage.png as new baseline
          for dir in ci_visual_results/ci_*/; do
            RESULT_FILE="$dir/results.json"
            STAGE_PNG="$dir/stage.png"
            # Only promote if the job passed (no FAILED marker)
            if [ -f "$STAGE_PNG" ] && [ ! -f "$dir/FAILED" ]; then
              SLUG=$(basename "$dir" | sed 's/ci_[0-9_]*//')
              echo "  Promoting: $STAGE_PNG"
              # In real use, copy to baseline_dir with correct name:
              # cp "$STAGE_PNG" "design_baselines/${SLUG}.png"
            fi
          done
          echo "âœ… Baseline export complete"

      - name: Cache updated baselines
        uses: actions/cache/save@v4
        with:
          path: design_baselines
          key: visual-baselines-${{ github.sha }}
